---
title: "Main R Markdown Document For NCAA Basketball Analysis"
author: "Ben Wasserman and Connor Kennedy"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('tidyverse')
library('magrittr')
library('caret')
library(plotROC)
```

In this document we clean the data, join the day, add some columns, create factors, and provide some summary statistics around the data. We are  also interested in adding TV ratings and/or revenue to see how upsets and seasons affect TV ratings and revenue generated

```{r}
# get and set working directory

# remove environment variables
rm(list = ls())

# read in files
tourney_games <- read.csv("ConferenceTourneyGames.csv")
tourney_compact_results <- read.csv("NCAATourneyCompactResults.csv")
regular_season_compact_results <- read.csv("RegularSeasonCompactResults.csv")
#seasons <- read.csv("Seasons.csv")
#team_coaches <- read.csv("TeamCoaches.csv")
teams <- read.csv("Teams.csv")
team_conferences <- read.csv("TeamConferences.csv")
tourney_seeds <- read.csv("NCAATourneySeeds.csv")
tourney_seeds_round_slots <- read.csv("NCAATourneySeedRoundSlots.csv")
tourney_detailed_result <- read.csv("NCAATourneyDetailedResults.csv")
tourney_result_unmodified <- read.csv("NCAATourneyDetailedResults.csv")
tourney_slots <- read.csv("NCAATourneySlots.csv")
regular_detailed_result <- read.csv("RegularSeasonDetailedResults.csv")
rankings <- read.csv("MasseyOrdinals.csv")
```

- Parse tournament data
```{r}
########### BELOW ARE A VARIETY OF DATA CLEANING AND FEATURE ENGINEERING ################
tourney_slots <- tourney_slots %>% rename(GameSlot = Slot)

rankings <- rankings %>% filter(RankingDayNum > 132)

table(rankings$SystemName)

rankings <- rankings %>% rename(DayNum = RankingDayNum)

rankings <- rankings %>% select(Season, SystemName, TeamID, everything())

# get rid of duplicates by system name, season, and team ID
rankings <- rankings[!duplicated(rankings[1:3]),]

# parse rankings
bih_rankings <- rankings %>% filter(SystemName == 'BIH')
col_rankings <- rankings %>% filter(SystemName == 'COL')
dol_rankings <- rankings %>% filter(SystemName == 'DOL')
mor_rankings <- rankings %>% filter(SystemName == 'MOR')
wlk_rankings <- rankings %>% filter(SystemName == 'WLK')
wob_rankings <- rankings %>% filter(SystemName == 'WOB')
wol_rankings <- rankings %>% filter(SystemName == 'WOL')


bih_rankings <- bih_rankings %>% rename(WTeamID = TeamID,
                                        WRankBih = OrdinalRank)

col_rankings <- col_rankings %>% rename(WTeamID = TeamID,
                                        WRankCol = OrdinalRank)

dol_rankings <- dol_rankings %>% rename(WTeamID = TeamID,
                                        WRankDol = OrdinalRank)


wlk_rankings <- wlk_rankings %>% rename(WTeamID = TeamID,
                                        WRankWlk = OrdinalRank)

wob_rankings <- wob_rankings %>% rename(WTeamID = TeamID,
                                        WRankWob = OrdinalRank)


wol_rankings <- wol_rankings %>% rename(WTeamID = TeamID,
                                        WRankWol = OrdinalRank)

mor_rankings <- mor_rankings %>% rename(WTeamID = TeamID,
                                        WRankMor = OrdinalRank)


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = bih_rankings,
                                    by = c("Season", "WTeamID"))


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wob_rankings,
                                    by = c("Season", "WTeamID"))


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wol_rankings,
                                    by = c("Season", "WTeamID"))


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wlk_rankings,
                                    by = c("Season", "WTeamID"))


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = dol_rankings,
                                    by = c("Season", "WTeamID"))


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = col_rankings,
                                    by = c("Season", "WTeamID"))


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = mor_rankings,
                                    by = c("Season", "WTeamID"))


# add losing teams rankings
bih_rankings <- bih_rankings %>% rename(LTeamID = WTeamID,
                                        LRankBih = WRankBih)

col_rankings <- col_rankings %>% rename(LTeamID = WTeamID,
                                        LRankCol = WRankCol)

dol_rankings <- dol_rankings %>% rename(LTeamID = WTeamID,
                                        LRankDol = WRankDol)

wlk_rankings <- wlk_rankings %>% rename(LTeamID = WTeamID,
                                        LRankWlk = WRankWlk)

wob_rankings <- wob_rankings %>% rename(LTeamID = WTeamID,
                                        LRankWob = WRankWob)

wol_rankings <- wol_rankings %>% rename(LTeamID = WTeamID,
                                        LRankWol = WRankWol)

mor_rankings <- mor_rankings %>% rename(LTeamID = WTeamID,
                                        LRankMor = WRankMor)


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = bih_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wob_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wol_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wlk_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = dol_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = col_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = mor_rankings,
                                    by = c("Season", "LTeamID"))

# remove unecessary columns
tourney_detailed_result = tourney_detailed_result[,-grep("^DayNum.",colnames(tourney_detailed_result))]
tourney_detailed_result = tourney_detailed_result[,-grep("^SystemName",colnames(tourney_detailed_result))]


# just get the average seed for each
tourney_detailed_result <- tourney_detailed_result %>% mutate(
  WAvgSeed = ((WRankMor + WRankWol + WRankBih + WRankWob + WRankWlk + WRankDol
               + WRankCol)/7),
  LAvgSeed = ((LRankMor + LRankWol + LRankBih + LRankWob + LRankWlk + LRankBih
               + LRankCol)/7),
  AvgSeedDiff = WAvgSeed - LAvgSeed
)


# merge rounds, teams, and seeds
rounds_df <- left_join(x = tourney_slots,
                       y = tourney_seeds_round_slots,
                       by = "GameSlot")

# reorder by column name
rounds_df <- rounds_df[c("Season", "GameSlot", "WeakSeed", "GameRound")]

# get rid of duplicates
rounds_df <- rounds_df[!duplicated(rounds_df[1:4]),]

# join by slot and season
rounds_df <- left_join(rounds_df, 
                       tourney_slots, 
                       by = c("GameSlot", "Season"))

# team conferences to tourney results
team_conferences <- team_conferences %>% rename(WTeamID = TeamID)

# join with conferences
tourney_detailed_result <- left_join(x = tourney_detailed_result,
                                     y = team_conferences, 
                                     by = c("WTeamID", "Season"))

team_conferences <- team_conferences %>% rename(LTeamID = WTeamID)

tourney_detailed_result <- left_join(x = tourney_detailed_result,
                                     y = team_conferences, 
                                     by = c("LTeamID", "Season"))

tourney_detailed_result <- tourney_detailed_result %>% rename(
  WTeamConf = ConfAbbrev.x,
  LTeamConf = ConfAbbrev.y 
)

# get rid of seeds prior to 2002 for consistency
tourney_seeds <- subset(tourney_seeds, Season > 2002)
tourney_seeds <- tourney_seeds %>% rename(WTeamID = TeamID)

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = tourney_seeds,
                                    by = c("WTeamID", "Season"))

tourney_seeds <- tourney_seeds %>% rename(LTeamID = WTeamID)

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = tourney_seeds,
                                    by = c("LTeamID", "Season"))

tourney_detailed_result <- tourney_detailed_result %>% rename(
  WTeamSeed = Seed.x,
  LTeamSeed = Seed.y
)

# make all the seeds only numeric
tourney_detailed_result$WTeamSeed <- as.integer(gsub('[a-zA-Z]', '',
                                                     tourney_detailed_result$WTeamSeed))
tourney_detailed_result$LTeamSeed <- as.integer(gsub('[a-zA-Z]', '',
                                                     tourney_detailed_result$LTeamSeed))



# now I'm going to look to make a model for lower team wins and higher team wins
tourney_detailed_result <- tourney_detailed_result %>% mutate(
  lower_team = pmin(WTeamID, LTeamID),
  higher_team = pmax(WTeamID, LTeamID),
  higher_team_won = ifelse(higher_team == WTeamID, 1, 0),
  HTSeed = ifelse(higher_team == WTeamID, WTeamSeed, LTeamSeed),
  LTSeed = ifelse(lower_team == WTeamID, WTeamSeed, LTeamSeed),
  HTScore = ifelse(higher_team == WTeamID, WScore, LScore),
  LTScore = ifelse(lower_team == WTeamID, WScore, LScore),
  HTConf = ifelse(higher_team == WTeamID, as.character(WTeamConf), as.character(LTeamConf)),
  LTConf = ifelse(lower_team == WTeamID, as.character(WTeamConf), as.character(LTeamConf)),
  HTFGM = ifelse(higher_team == WTeamID, WFGM, LFGM),
  LTFGM = ifelse(lower_team == WTeamID, WFGM, LFGM),
  HTFGA = ifelse(higher_team == WTeamID, WFGA, LFGA),
  LTFGA = ifelse(lower_team == WTeamID, WFGA, LFGA),
  HTFGM3 = ifelse(higher_team == WTeamID, WFGM3, LFGM3),
  LTFGM3 = ifelse(lower_team == WTeamID, WFGM3, LFGM3),
  HTFGA3 = ifelse(higher_team == WTeamID, WFGA3, LFGA3),
  LTFGA3 = ifelse(lower_team == WTeamID, WFGA3, LFGA3),
  HTFTM = ifelse(higher_team == WTeamID, WFTM, LFTM),
  LTFTM = ifelse(lower_team == WTeamID, WFTM, LFTM),
  HTFTA = ifelse(higher_team == WTeamID, WFTA, LFTA),
  LTFTA = ifelse(lower_team == WTeamID, WFTA, LFTA),
  HTOR = ifelse(higher_team == WTeamID, WOR, LOR),
  LTOR = ifelse(lower_team == WTeamID, WOR, LOR),
  HTDR = ifelse(higher_team == WTeamID, WDR, LDR),
  LTDR = ifelse(lower_team == WTeamID, WDR, LDR),
  HTAst = ifelse(higher_team == WTeamID, WAst, LAst),
  LTAst = ifelse(lower_team == WTeamID, WAst, LAst),
  HTTO = ifelse(higher_team == WTeamID, WTO, LTO),
  LTTO = ifelse(lower_team == WTeamID, WTO, LTO),
  HTStl = ifelse(higher_team == WTeamID, WStl, LStl),
  LTStl = ifelse(lower_team == WTeamID, WStl, LStl),
  HTBlk = ifelse(higher_team == WTeamID, WBlk, LBlk),
  LTBlk = ifelse(lower_team == WTeamID, WBlk, LBlk),
  HTPF = ifelse(higher_team == WTeamID, WPF, LPF),
  LTPF = ifelse(lower_team == WTeamID, WPF, LPF),
  HTBih = ifelse(higher_team == WTeamID, WRankBih, LRankBih),
  LTBih = ifelse(lower_team == WTeamID, WRankBih, LRankBih),
  HTCol = ifelse(higher_team == WTeamID, WRankCol, LRankCol),
  LTCol = ifelse(lower_team == WTeamID, WRankCol, LRankCol),
  HTDol = ifelse(higher_team == WTeamID, WRankDol, LRankDol),
  LTDol = ifelse(lower_team == WTeamID, WRankDol, LRankDol),
  HTMor = ifelse(higher_team == WTeamID, WRankMor, LRankMor),
  LTMor = ifelse(lower_team == WTeamID, WRankMor, LRankMor),
  HTWlk = ifelse(higher_team == WTeamID, WRankWlk, LRankWlk),
  LTWlk = ifelse(lower_team == WTeamID, WRankWlk, LRankWlk),
  HTWob = ifelse(higher_team == WTeamID, WRankWob, LRankWob),
  LTWob = ifelse(lower_team == WTeamID, WRankWob, LRankWob),
  HTWol = ifelse(higher_team == WTeamID, WRankWol, LRankWol),
  LTWol = ifelse(lower_team == WTeamID, WRankWol, LRankWol),
  HTAvgRank = ifelse(higher_team == WTeamID, WAvgSeed, LAvgSeed),
  LTAvgRank = ifelse(lower_team == WTeamID, WAvgSeed, LAvgSeed),
  DefaultTest = ifelse(WTeamSeed > LTeamSeed, 1, 0)
)

# Create new variables that account for the randomness of seed assignment
names(tourney_detailed_result)

tourney_detailed_result <- tourney_detailed_result %>% mutate(LTeamConfFactor = fct_lump(LTeamConf, 10))

tourney_detailed_result <- tourney_detailed_result %>% mutate(WTeamConfFactor = fct_lump(WTeamConf, 10))

# need to think about correlation between all the rankings
tourney_detailed_result <- tourney_detailed_result %>% select(
  Season, DayNum, NumOT, lower_team, higher_team, higher_team_won,
  HTSeed, LTSeed, HTScore, LTScore, HTConf, LTConf, HTFGM, 
  LTFGM, HTFGA, LTFGA, HTFGM3, LTFGM3, HTFGA3, LTFGA3, HTFTM, 
  LTFTM, HTFTA, LTFTA, HTOR, LTOR, HTDR, LTDR, HTAst, LTAst, HTTO,
  LTTO, HTStl, LTStl, HTBlk, LTBlk, HTPF, LTPF, HTBih, LTBih, HTCol,
  LTCol, HTDol, LTDol, HTMor, LTMor, HTWlk, LTWlk, HTWob, LTWob, HTWol,
  LTWol, DefaultTest, HTAvgRank, LTAvgRank, AvgSeedDiff, WTeamSeed, LTeamSeed,
  WScore, LScore, WFGM, LFGM, WTeamID, LTeamID, WFGM3, LFGM3, WTeamConfFactor, 
  LTeamConfFactor
)

dim(tourney_detailed_result)

# add team names
teams <- teams %>% select(TeamName, TeamID)
teams <- teams %>% rename(lower_team = TeamID)
tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = teams,
                                    by = "lower_team")


teams <- teams %>% rename(higher_team = lower_team)
tourney_detailed_result <- left_join(x = tourney_detailed_result,
                                     y = teams, 
                                     by = "higher_team")


# renaming
tourney_detailed_result %<>% rename(LowerTeamName = TeamName.x,
                                    HigherTeamName = TeamName.y)

# add score difference
tourney_detailed_result <- tourney_detailed_result %>% mutate(scoreDiff = HTScore - LTScore)


# add rounds to tourney_detailed_results
tourney_detailed_result <- tourney_detailed_result %>% mutate(Round = ifelse(
  DayNum %in% 134:135, 0,
  ifelse(DayNum %in% 136:137, 1,
         ifelse(DayNum %in% 138:139, 2,
                ifelse(DayNum %in% 143:144, 3,
                       ifelse(DayNum %in% 145:146, 4,
                              ifelse(DayNum == 152, 5,
                                     ifelse(DayNum == 154, 6, 7))))))
))


# factoring 
tourney_detailed_result %<>% mutate(Season = factor(Season),
                                    DayNum = factor(DayNum),
                                    HigherTeamName = factor(HigherTeamName),
                                    LowerTeamName = factor(LowerTeamName),
                                    NumOT = factor(NumOT))


tourney_detailed_result <- tourney_detailed_result %>% mutate(HTeamConfFactor = fct_lump(HTConf, 10))

tourney_detailed_result <- tourney_detailed_result %>% mutate(LTeamConfFactor = 
                                                                fct_lump(LTConf, 10))

# tourney_selected_vars <- tourney_detailed_result %>% select(
#  DFTM, DStl, DFGA, DFGA3, DFGM3, DFTA, DOR, DDR,
#  DTO, DAst, Round, WTeamConfFactor, WTeamID, LTeamID,
#  LTeamConfFactor, scoreDiff, WTeamSeed, LTeamSeed, DBlk, DPF,
#  higher_team_won, LFTM, LStl, LFGA, LFGA3, LFGM3, LFTA, LOR,
#  LDR, LTO, LAst, WFTM, WStl, WFGA, WFGA3, WFGM3, WFTA, WOR, WDR, WTO, WAst
#)

tourney_detailed_result <- tourney_detailed_result %>% mutate(
  SeedDifference = HTSeed - LTSeed
)

# transition all wins and losses into deltas
tourney_detailed_result <- tourney_detailed_result %>% mutate(
  DFTM = HTFTM - LTFTM,
  DStl = HTStl - LTStl,
  DFGA = HTFGA - LTFGA,
  DFGA3 = HTFGA3 - LTFGA3,
  DFGM3 = HTFGM3 - LTFGM3,
  DFTM = HTFTM - LTFTM,
  DFTA = HTFTA - LTFTA,
  DOR = HTOR - LTOR,
  DDR = HTDR - LTDR,
  DTO = HTTO - LTTO,
  DAst = HTAst - LTAst,
  DBlk = HTBlk - LTBlk,
  DPF = HTPF - LTPF
)

names(tourney_detailed_result)


```



```{r}
##### Regular Season Parsing ########

rankings <- read.csv('MasseyOrdinals.csv')
team_conferences <- read.csv("TeamConferences.csv")
regular_detailed_result <- read.csv("RegularSeasonDetailedResults.csv")

rankings <- rankings %>% filter(between(rankings$RankingDayNum, 110, 130))

rankings <- rankings %>% select(Season, SystemName, TeamID, everything())

# get rid of duplicates by system name, season, and team ID
rankings <- rankings[!duplicated(rankings[1:3]),]

View(rankings)

# parse rankings
bih_rankings <- rankings %>% filter(SystemName == 'BIH')
col_rankings <- rankings %>% filter(SystemName == 'COL')
dol_rankings <- rankings %>% filter(SystemName == 'DOL')
mor_rankings <- rankings %>% filter(SystemName == 'MOR')
wlk_rankings <- rankings %>% filter(SystemName == 'WLK')
wob_rankings <- rankings %>% filter(SystemName == 'WOB')
wol_rankings <- rankings %>% filter(SystemName == 'WOL')

bih_rankings <- bih_rankings %>% rename(WTeamID = TeamID,
                                        WRankBih = OrdinalRank)

col_rankings <- col_rankings %>% rename(WTeamID = TeamID,
                                        WRankCol = OrdinalRank)

dol_rankings <- dol_rankings %>% rename(WTeamID = TeamID,
                                        WRankDol = OrdinalRank)


wlk_rankings <- wlk_rankings %>% rename(WTeamID = TeamID,
                                        WRankWlk = OrdinalRank)

wob_rankings <- wob_rankings %>% rename(WTeamID = TeamID,
                                        WRankWob = OrdinalRank)


wol_rankings <- wol_rankings %>% rename(WTeamID = TeamID,
                                        WRankWol = OrdinalRank)

mor_rankings <- mor_rankings %>% rename(WTeamID = TeamID,
                                        WRankMor = OrdinalRank)


regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = bih_rankings,
                                    by = c("Season", "WTeamID"))



regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = wob_rankings,
                                    by = c("Season", "WTeamID"))


regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = wol_rankings,
                                    by = c("Season", "WTeamID"))


regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = wlk_rankings,
                                    by = c("Season", "WTeamID"))


regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = dol_rankings,
                                    by = c("Season", "WTeamID"))

regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = col_rankings,
                                    by = c("Season", "WTeamID"))

regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = mor_rankings,
                                    by = c("Season", "WTeamID"))


View(regular_detailed_result)



# add losing teams rankings
bih_rankings <- bih_rankings %>% rename(LTeamID = WTeamID,
                                        LRankBih = WRankBih)

col_rankings <- col_rankings %>% rename(LTeamID = WTeamID,
                                        LRankCol = WRankCol)

dol_rankings <- dol_rankings %>% rename(LTeamID = WTeamID,
                                        LRankDol = WRankDol)

wlk_rankings <- wlk_rankings %>% rename(LTeamID = WTeamID,
                                        LRankWlk = WRankWlk)

wob_rankings <- wob_rankings %>% rename(LTeamID = WTeamID,
                                        LRankWob = WRankWob)

wol_rankings <- wol_rankings %>% rename(LTeamID = WTeamID,
                                        LRankWol = WRankWol)

mor_rankings <- mor_rankings %>% rename(LTeamID = WTeamID,
                                        LRankMor = WRankMor)

View(regular_detailed_result)


regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = bih_rankings,
                                    by = c("Season", "LTeamID"))

regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = wob_rankings,
                                    by = c("Season", "LTeamID"))

regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = wol_rankings,
                                    by = c("Season", "LTeamID"))

regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = wlk_rankings,
                                    by = c("Season", "LTeamID"))

regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = dol_rankings,
                                    by = c("Season", "LTeamID"))

regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = col_rankings,
                                    by = c("Season", "LTeamID"))

regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = mor_rankings,
                                    by = c("Season", "LTeamID"))

# remove unecessary columns
regular_detailed_result = regular_detailed_result[,-grep("^RankingDayNum",colnames(regular_detailed_result))]
regular_detailed_result = regular_detailed_result[,-grep("^SystemName",colnames(regular_detailed_result))]


# just get the last 15 games of the regular season
regular_detailed_result <- regular_detailed_result %>% filter(between(regular_detailed_result$DayNum, 1, 132))

names(regular_detailed_result)


# just get the average seed for each
regular_detailed_result <- regular_detailed_result %>% mutate(
  WAvgSeed = ((WRankMor + WRankWol + WRankWob + WRankWlk + WRankDol + WRankBih
               + WRankCol)/7),
  LAvgSeed = ((LRankMor + LRankWol + LRankWob + LRankWlk + LRankBih + LRankBih
               + LRankCol)/7),
  AvgSeedDiff = WAvgSeed - LAvgSeed
)

# team conferences to tourney results
team_conferences <- team_conferences %>% rename(WTeamID = TeamID)

# join with conferences
regular_detailed_result <- left_join(x = regular_detailed_result,
                                     y = team_conferences, 
                                     by = c("WTeamID", "Season"))

team_conferences <- team_conferences %>% rename(LTeamID = WTeamID)

regular_detailed_result <- left_join(x = regular_detailed_result,
                                     y = team_conferences, 
                                     by = c("LTeamID", "Season"))

regular_detailed_result <- regular_detailed_result %>% rename(
  WTeamConf = ConfAbbrev.x,
  LTeamConf = ConfAbbrev.y 
)



# now I'm going to look to make a model for lower team wins and higher team wins
regular_detailed_result <- regular_detailed_result %>% mutate(
  lower_team = pmin(WTeamID, LTeamID),
  higher_team = pmax(WTeamID, LTeamID),
  higher_team_won = ifelse(higher_team == WTeamID, 1, 0),
  HTScore = ifelse(higher_team == WTeamID, WScore, LScore),
  LTScore = ifelse(lower_team == WTeamID, WScore, LScore),
  HTConf = ifelse(higher_team == WTeamID, as.character(WTeamConf), as.character(LTeamConf)),
  LTConf = ifelse(lower_team == WTeamID, as.character(WTeamConf), as.character(LTeamConf)),
  HTFGM = ifelse(higher_team == WTeamID, WFGM, LFGM),
  LTFGM = ifelse(lower_team == WTeamID, WFGM, LFGM),
  HTFGA = ifelse(higher_team == WTeamID, WFGA, LFGA),
  LTFGA = ifelse(lower_team == WTeamID, WFGA, LFGA),
  HTFGM3 = ifelse(higher_team == WTeamID, WFGM3, LFGM3),
  LTFGM3 = ifelse(lower_team == WTeamID, WFGM3, LFGM3),
  HTFGA3 = ifelse(higher_team == WTeamID, WFGA3, LFGA3),
  LTFGA3 = ifelse(lower_team == WTeamID, WFGA3, LFGA3),
  HTFTM = ifelse(higher_team == WTeamID, WFTM, LFTM),
  LTFTM = ifelse(lower_team == WTeamID, WFTM, LFTM),
  HTFTA = ifelse(higher_team == WTeamID, WFTA, LFTA),
  LTFTA = ifelse(lower_team == WTeamID, WFTA, LFTA),
  HTOR = ifelse(higher_team == WTeamID, WOR, LOR),
  LTOR = ifelse(lower_team == WTeamID, WOR, LOR),
  HTDR = ifelse(higher_team == WTeamID, WDR, LDR),
  LTDR = ifelse(lower_team == WTeamID, WDR, LDR),
  HTAst = ifelse(higher_team == WTeamID, WAst, LAst),
  LTAst = ifelse(lower_team == WTeamID, WAst, LAst),
  HTTO = ifelse(higher_team == WTeamID, WTO, LTO),
  LTTO = ifelse(lower_team == WTeamID, WTO, LTO),
  HTStl = ifelse(higher_team == WTeamID, WStl, LStl),
  LTStl = ifelse(lower_team == WTeamID, WStl, LStl),
  HTBlk = ifelse(higher_team == WTeamID, WBlk, LBlk),
  LTBlk = ifelse(lower_team == WTeamID, WBlk, LBlk),
  HTPF = ifelse(higher_team == WTeamID, WPF, LPF),
  LTPF = ifelse(lower_team == WTeamID, WPF, LPF),
  HTBih = ifelse(higher_team == WTeamID, WRankBih, LRankBih),
  LTBih = ifelse(lower_team == WTeamID, WRankBih, LRankBih),
  HTCol = ifelse(higher_team == WTeamID, WRankCol, LRankCol),
  LTCol = ifelse(lower_team == WTeamID, WRankCol, LRankCol),
  HTDol = ifelse(higher_team == WTeamID, WRankDol, LRankDol),
  LTDol = ifelse(lower_team == WTeamID, WRankDol, LRankDol),
  HTMor = ifelse(higher_team == WTeamID, WRankMor, LRankMor),
  LTMor = ifelse(lower_team == WTeamID, WRankMor, LRankMor),
  HTWlk = ifelse(higher_team == WTeamID, WRankWlk, LRankWlk),
  LTWlk = ifelse(lower_team == WTeamID, WRankWlk, LRankWlk),
  HTWol = ifelse(higher_team == WTeamID, WRankWol, LRankWol),
  LTWol = ifelse(lower_team == WTeamID, WRankWol, LRankWol)
)

# Create new variables that account for the randomness of seed assignment
names(regular_detailed_result)

# need to think about correlation between all the rankings
regular_detailed_result <- regular_detailed_result %>% select(
  Season, DayNum, NumOT, lower_team, higher_team, higher_team_won,
  HTScore, LTScore, HTConf, LTConf, HTFGM, 
  LTFGM, HTFGA, LTFGA, HTFGM3, LTFGM3, HTFGA3, LTFGA3, HTFTM, 
  LTFTM, HTFTA, LTFTA, HTOR, LTOR, HTDR, LTDR, HTAst, LTAst, HTTO,
  LTTO, HTStl, LTStl, HTBlk, LTBlk, HTPF, LTPF, HTBih, LTBih, HTCol,
  LTCol, HTDol, LTDol, HTMor, LTMor, HTWlk, LTWlk, HTWol,
  LTWol, AvgSeedDiff
)

dim(regular_detailed_result)

# add team names
teams <- read.csv("Teams.csv")
teams <- teams %>% select(TeamName, TeamID)
teams <- teams %>% rename(lower_team = TeamID)
regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = teams,
                                    by = "lower_team")


teams <- teams %>% rename(higher_team = lower_team)
regular_detailed_result <- left_join(x = regular_detailed_result,
                                     y = teams, 
                                     by = "higher_team")


# renaming
regular_detailed_result %<>% rename(LowerTeamName = TeamName.x,
                                    HigherTeamName = TeamName.y)

# add score difference
regular_detailed_result <- regular_detailed_result %>% mutate(scoreDiff = HTScore - LTScore)



# factoring 
regular_detailed_result %<>% mutate(Season = factor(Season),
                                    DayNum = factor(DayNum),
                                    HigherTeamName = factor(HigherTeamName),
                                    LowerTeamName = factor(LowerTeamName),
                                    NumOT = factor(NumOT))


regular_detailed_result <- regular_detailed_result %>% mutate(HTeamConfFactor = fct_lump(HTConf, 10))

regular_detailed_result <- regular_detailed_result %>% mutate(LTeamConfFactor = 
                                                                fct_lump(LTConf, 10))

View(averages)


# transition all wins and losses into deltas
regular_detailed_result <- regular_detailed_result %>% mutate(
  DFTM = HTFTM - LTFTM,
  DFGM = HTFGM - LTFGM,
  DStl = HTStl - LTStl,
  DFGA = HTFGA - LTFGA,
  DFGA3 = HTFGA3 - LTFGA3,
  DFGM3 = HTFGM3 - LTFGM3,
  DFTM = HTFTM - LTFTM,
  DFTA = HTFTA - LTFTA,
  DOR = HTOR - LTOR,
  DDR = HTDR - LTDR,
  DTO = HTTO - LTTO,
  DAst = HTAst - LTAst,
  DBlk = HTBlk - LTBlk,
  DPF = HTPF - LTPF
)

names(regular_detailed_result)
View(regular_detailed_result)

averages <- regular_detailed_result %>% 
  group_by(higher_team, Season) %>% 
  summarize(DFTMReg = mean(DFTM, na.rm = TRUE),
            DFGMReg = mean(DFGM, na.rm = TRUE),
            DStlReg = mean(DStl, na.rm = TRUE),
            DFGAReg = mean(DFGA, na.rm = TRUE),
            DFGA3Reg = mean(DFGA3, na.rm = TRUE),
            DFGM3Reg = mean(DFGM3, na.rm = TRUE),
            DFTAReg = mean(DFTA, na.rm = TRUE),
            DORReg = mean(DOR, na.rm = TRUE),
            DDRReg = mean(DDR, na.rm = TRUE),
            DTOReg = mean(DTO, na.rm = TRUE),
            DAstReg = mean(DAst, na.rm =TRUE),
            DBlkReg = mean(DBlk, na.rm = TRUE),
            DPFAReg = mean(DPF, na.rm = TRUE))

View(averages)


####### HERE ISN'T IN THE OTHER FILE #####
tourney_detailed_result <- left_join(x = tourney_detailed_result,
                                     y = averages, 
                                     by = "higher_team", "Season")


View(regular_detailed_result)
View(tourney_detailed_result)
names(tourney_detailed_result)
names(regular_detailed_result)


tourney_model_df <- tourney_detailed_result %>% select(
  higher_team, lower_team, higher_team_won, HTeamConfFactor,
  LTeamConfFactor, DFTMReg, DStlReg, DFGAReg, DFGA3Reg, DFGMReg,
  DStlReg, DFGAReg, DFGA3Reg, DFGM3Reg, DFTAReg, DORReg, DDRReg,
  DTOReg, DAstReg, DBlkReg, DPFAReg, AvgSeedDiff, Season.y, DayNum
)

tourney_model_df <- tourney_model_df %>% rename(
  DFTM = DFTMReg,
  DStl = DStlReg,
  DFGA = DFGAReg,
  DFGA3 = DFGA3Reg,
  DFGM3 = DFGM3Reg,
  DFGM = DFGMReg,
  DFTA = DFTAReg,
  DOR = DORReg,
  DDR = DDRReg,
  DTO = DTOReg,
  DAst = DAstReg,
  DBlk = DBlkReg,
  DPF = DPFAReg,
  Season = Season.y
)

reg_model_df <- regular_detailed_result %>% select(
  higher_team, lower_team, higher_team_won, HTeamConfFactor,
  LTeamConfFactor, DFTM, DStl, DFGA, DFGA3, DFGM3, DFGM, DFTA,
  DOR, DDR, DTO, DAst, DBlk, DPF, Season, DayNum, AvgSeedDiff
)

dim(reg_model_df)
dim(tourney_model_df)
names(reg_model_df)
names(tourney_model_df)

View(tourney_model_df)

```

Summary Statistics
```{r}
library(glmnet)
library(glmnetUtils)
library(coefplot)

tourney_detailed_result <- na.omit(tourney_detailed_result)
names(tourney_detailed_result)


tourney_without_conf <- tourney_detailed_result %>% select(AvgSeedDiff, SeedDifference, HTeamConfFactor, LTeamConfFactor, higher_team_won)


# wins per team
wins_per_team <- tourney_result_unmodified %>% group_by(WTeamID) %>% summarize(num_wins = n()) %>% arrange(desc(num_wins))
wins_per_team
wins_per_team %<>% rename(higher_team = WTeamID)
wins_per_team <- left_join(x = wins_per_team,
                           y = teams,
                           by = "higher_team")
wins_per_team <- wins_per_team %>% rename(WTeamID = higher_team) %>% select(WTeamID, TeamName, num_wins) %>% arrange(desc(num_wins))
head(wins_per_team)

# winning summary 
winning_pts_summary <- tourney_result_unmodified %>% summarize(min_fg_made = min(WFGM),
                                                               mean_fg_made = mean(WFGM),
                                                               max_fg_made = max(WFGM),
                                                               sd_fg_made = sd(WFGM),
                                                               min_3pts_made = min(WFGM3),
                                                               mean_3pts_made = mean(WFGM3),
                                                               max_3pts_made = max(WFGM3),
                                                               sd_3pts_made = sd(WFGM3),
                                                               )
winning_pts_summary

# mean winner points summary
mean_pts_summary <- tourney_result_unmodified %>% summarize(win_mean_fg_made = mean(WFGM),
                                                            win_mean_3pts_made = mean(WFGM3),
                                                            lose_mean_fg_made = mean(LFGM),
                                                            lose_mean_3pts_made = mean(LFGM3)
                                                            )
mean_pts_summary

# season summary
season <- tourney_detailed_result1 %>% group_by(Season) %>% group_by(winner) %>% summarize(mean(HTScore))
season

# summary of Scores and Points
summary_scores_points <- tourney_detailed_result %>%
  select(HTScore, LTScore, HTFGM, HTFGA, LTFGM, LTFGA, HTFGM3, HTFGA3, LTFGM3, LTFGA3) 
summary(summary_scores_points)

# summary details of score by HTSeed
HTSeed_details <- tourney_detailed_result %>% group_by(HTSeed) %>%
  summarize(avg_points_HTSeed = mean(HTScore),
            max_points_HTSeed = max(HTScore),
            min_points_HTSeed = min(HTScore))
HTSeed_details

# summary details of score by LTSeed
LTSeed_details <- tourney_detailed_result %>% group_by(LTSeed) %>%
  summarize(avg_points_LTSeed = mean(LTScore),
            max_points_LTSeed = max(LTScore),
            min_points_LTSeed = min(LTScore))
LTSeed_details

set.seed(1861)
(num_rows <- nrow(tourney_detailed_result))
train_idx <- sample(1:num_rows, floor(.8 * num_rows))

tourney_detailed_train <- tourney_without_conf %>% slice(train_idx)
tourney_detailed_test <- tourney_without_conf %>% slice(-train_idx)
tourney_detailed_2017 <- subset(tourney_detailed_result, Season == 2017)

# summary details of three points by season
three_pt_details <- tourney_detailed_result %>% group_by(Season) %>%
  summarize(avg_three_pts = mean(HTFGM3),
            max_three_pts = max(HTFGM3),
            min_three_pts = min(HTFGM3))
three_pt_details

# alpha = 0 for ridge 
ridge_fit <- cv.glmnet(higher_team_won ~ .,
          data = tourney_detailed_train,
          family = "binomial",
          alpha = 0,
          nfolds = 10)

coefpath(ridge_fit)

plot(ridge_fit)

ridge_preds <- predict(ridge_fit, newdata = tourney_detailed_test, s = ridge_fit$lambda.min)
ridge_preds <- predict(ridge_fit, newdata = tourney_detailed_2017, s = ridge_fit$lambda.min)

preds_test_ridge <- data.frame(
  tourney_detailed_test,
  ridge_preds
)

preds_2017_ridge <- data.frame(
  tourney_detailed_2017,
  ridge_preds
)

preds_test_ridge <- preds_test_ridge %>% mutate(
  class_pred05 = ifelse(ridge_preds > .5, "Yes", "No")
)

preds_2017_ridge <- preds_2017_ridge %>% mutate(
  class_pred05 = ifelse(ridge_preds > .05, "Yes", "No")
)


table(preds_test_ridge$class_pred05, preds_test_ridge$higher_team_won)
table(preds_2017_ridge$class_pred05, preds_2017_ridge$higher_team_won)

(roc_test <- ggplot(preds_2017_ridge, aes(m = ridge_preds,
                                      d = higher_team_won)) + 
  geom_roc(cutoffs.at = c(.99, .9, .75, .5, .25, .1, .01)))


```


```{r}
tourney_lasso <- tourney_detailed_result %>% select(AvgSeedDiff, HTeamConfFactor, LTeamConfFactor, higher_team_won)

# alpha = 1 for lasso 
lasso_fit <- cv.glmnet(higher_team_won ~ .,
          data = tourney_without_conf,
          family = "binomial",
          alpha = 1,
          nfolds = 10)

coefpath(lasso_fit)

plot(lasso_fit)

lasso_preds <- predict(lasso_fit, newdata = tourney_detailed_result, s = lasso_fit$lambda.min)

preds_train_lasso <- data.frame(
  tourney_detailed_result,
  lasso_preds
)

preds_train_lasso <- preds_train_lasso %>% mutate(
  class_pred05 = ifelse(lasso_preds > .05, "Yes", "No")
)

table(preds_train_lasso$class_pred05, preds_train_lasso$higher_team_won)

```



Working with TV ratings and number of viewers
```{r}
rating_round_viewers <- read.csv("rating_round_viewers.csv")
tourney_semi_views_ratings <- read.csv("semi_rating_round_viewers.csv")

View(tourney_semi_views_ratings)

# add TV ratings and viewers for championship games
rating_round_viewers %<>% rename(Round = Round)
rating_round_viewers <- rating_round_viewers %>% mutate(Season = factor(Season))

tourney_finals_views_ratings <-left_join(x = tourney_detailed_result,
                                    y = rating_round_viewers,
                                    by = c("Season", "Round"))

tourney_semi_views_ratings <- tourney_semi_views_ratings %>% rename(WTeamID = TeamID1)
tourney_semi_views_ratings <- tourney_semi_views_ratings %>% rename(LTeamID = TeamID2)

tourney_semi_views_ratings <- tourney_semi_views_ratings %>% mutate(
  Season = factor(Season)
)
View(tourney_semi_views_ratings)

# Data frame with the semi final ratings and viewers
tourney_semi_views_ratings <- left_join(x = tourney_detailed_result,
                                        y = tourney_semi_views_ratings,
                                        by= c("Season", "WTeamID", "LTeamID"))



# Data frame with the finals ratings and viewers
tourney_finals_views_ratings <- tourney_finals_views_ratings %>% filter(
  Round == 6
)

View(tourney_semi_views_ratings)

tourney_semi_views_ratings <- tourney_semi_views_ratings %>% rename(Round = Round.y)
tourney_semi_views_ratings <- tourney_semi_views_ratings %>% select(-Round.x)

tourney_semi_views_ratings <- tourney_semi_views_ratings %>% filter(
  Round == 5
)

tourney_views_ratings <- rbind(tourney_semi_views_ratings, tourney_finals_views_ratings)

tourney_views_ratings <- tourney_views_ratings %>% mutate(
  Network = factor(Network)
)

# how can I manipulate to look at upsets
View(tourney_views_ratings)
tourney_views_ratings <- tourney_views_ratings %>% mutate(
  IsUpset = ifelse(WTeamSeed < LTeamSeed, 1, 0)
)

tourney_views_ratings <- tourney_views_ratings %>% mutate(
  SeedDifference = abs(WTeamSeed - LTeamSeed)
)

tourney_views_ratings <- tourney_views_ratings %>% mutate(
  TotalThreesMade = WFGM3 + LFGM3,
  TotalFieldGoals = WFGM + LFGM,
  #TotalFieldGoalsAttempts = WFGA + LFGA,
  TotalPointsScored = WScore + LScore
)

View(tourney_views_ratings)


```



Regression for number of viewers and TV ratings
```{r}
##### Will need to do cross validation here since there isn't a ton of data ########

names(tourney_views_ratings)

lin_mod1 <- lm(Viewers ~ IsUpset + SeedDifference + TotalThreesMade + TotalPointsScored,
               data = tourney_views_ratings)

summary(lin_mod1)

tourney_views_ratings <- tourney_views_ratings %>% mutate(
  scoreDiff = WScore - LScore
)

# score difference and round are significant, ACC games are relevant
lin_mod2 <- lm(Viewers ~ relevel(WTeamConfFactor, ref="Other") + scoreDiff + IsUpset + WTeamSeed +
                 relevel(LTeamConfFactor, ref="Other"),
               data = tourney_views_ratings)

summary(lin_mod2)

preds_train_DF <- data.frame(
  preds = predict(lin_mod2),
  resids = tourney_views_ratings$Viewers - predict(lin_mod2),
  tourney_views_ratings
)

# Check for Heteroschedasticity
(ggplot(preds_train_DF, aes(x = resids, y = preds)) + 
  geom_point())


# I can do an elastic net here too


# I can show a variety of graphs as well

```



See how well the model performs only by seed
```{r}
preds_seed_df <- data.frame(
  tourney_detailed_result
)

preds_seed_df <- preds_seed_df %>% mutate(
  class_pred = ifelse(DefaultTest == 1, "Yes", "No")
)

table(preds_seed_df$class_pred, preds_seed_df$higher_team_won)

```


```{r}
# testing with the averaged data
tourney_model_df <- na.omit(tourney_model_df)
reg_model_df <- na.omit(reg_model_df)

names(reg_model_df)

View(reg_model_df)

 # HTeamConfFactor + LTeamConfFactor 
tourney_model_df <- tourney_model_df %>% filter(Season != 2009)
glm_fit <- glm(higher_team_won ~ + DFTM + 
                 DStl + DFGA + DFGA3 + DFGM3 + DFGM + DFTA + DOR + DDR + DTO + 
                 DAst + DBlk + DPF + AvgSeedDiff + Season,
               data = reg_model_df,
               family = binomial,
               maxit = 200)

summary(glm_fit)

preds_train_DF <- data.frame(
  scores_logit = predict(glm_fit, type = "response"),
  reg_model_df
)

preds_test_DF <- data.frame(
  scores_logit = predict(glm_fit, type = "response", newdata=tourney_model_df),
  tourney_model_df
)

preds_train_DF <- preds_train_DF %>% mutate(
  class_pred05 = ifelse(scores_logit > .5, "Yes", "No")
)

preds_test_DF <- preds_test_DF %>% mutate(
  class_pred05 = ifelse(scores_logit > .5, "Yes", "No")
)

table(preds_train_DF$class_pred05, preds_train_DF$higher_team_won)
table(preds_test_DF$class_pred05, preds_test_DF$higher_team_won)

```

```{r}
# logistic fit with a lot less data
tourney_detailed_result <- na.omit(tourney_detailed_result)

# Split into test and train
set.seed(1861)
(num_rows <- nrow(tourney_detailed_result))
train_idx <- sample(1:num_rows, floor(.8 * num_rows))

tourney_detailed_train <- tourney_detailed_result %>% slice(train_idx)
tourney_detailed_test <- tourney_detailed_result %>% slice(-train_idx)

glm_fit <- glm(higher_team_won ~ SeedDifference + AvgSeedDiff + HTeamConfFactor + 
                 LTeamConfFactor,
               data = tourney_detailed_train,
               family = binomial)

summary(glm_fit)

preds_test_DF <- data.frame(
  scores_logit = predict(glm_fit, type = "response", newdata = tourney_detailed_test),
  tourney_detailed_test
)

preds_train_DF <- data.frame(
  scores_logit = predict(glm_fit, type = "response", newdata = tourney_detailed_train),
  tourney_detailed_train
)

preds_test_DF <- preds_test_DF %>% mutate(
  class_pred05 = ifelse(scores_logit > .5, "Yes", "No")
)

preds_test_DF <- preds_test_DF %>% mutate(
  class_pred05 = ifelse(scores_logit > .5, "Yes", "No")
)

table(preds_test_DF$class_pred05, preds_test_DF$higher_team_won)
table(preds_test_DF$class_pred05, preds_test_DF$higher_team_won)


```

```{r}
(roc_test <- ggplot(preds_test_DF, aes(m = scores_logit,
                                      d = higher_team_won)) + 
  geom_roc(cutoffs.at = c(.99, .9, .75, .5, .25, .1, .01)))

```


Actual model that we're going to use!!
```{r}
tourney_detailed_result <- na.omit(tourney_detailed_result)

# Split into test and train
set.seed(1861)
(num_rows <- nrow(tourney_detailed_result))
train_idx <- sample(1:num_rows, floor(.8 * num_rows))

tourney_detailed_train <- tourney_detailed_result %>% slice(train_idx)
tourney_detailed_test <- tourney_detailed_result %>% slice(-train_idx)
tourney_detailed_2017 <- subset(tourney_detailed_result, Season == 2017)

glm_fit <- glm(higher_team_won ~ SeedDifference + AvgSeedDiff + HTeamConfFactor + 
                 LTeamConfFactor + DFTM + DStl + DFGA + DFGA3 + DFGM3 + DFTA + DOR + DDR
              + DOR + DTO + DAst + DBlk + DPF,
               data = tourney_detailed_train,
               family = binomial)

summary(glm_fit)

preds_test_DF <- data.frame(
  scores_logit = predict(glm_fit, type = "response", newdata = tourney_detailed_test),
  tourney_detailed_test
)

preds_2017_DF <- data.frame(
  scores_logit = predict(glm_fit, type = "response", newdata = tourney_detailed_2017),
  tourney_detailed_2017
)

preds_test_DF <- preds_test_DF %>% mutate(
  class_pred05 = ifelse(scores_logit > .5, "Yes", "No")
)

preds_test_2017 <- preds_2017_DF %>% mutate(
  class_pred05 = ifelse(scores_logit > .5, "Yes", "No")
)

table(preds_test_DF$class_pred05, preds_test_DF$higher_team_won)
table(preds_test_2017$class_pred05, preds_test_2017$higher_team_won)
```


Random Forest Model
```{r}
library(randomForest)
library(randomForestExplainer)
# DFTM + DFGM3 + DPF + DDR
rf_fit <- randomForest(as.factor(higher_team_won) ~ SeedDifference + AvgSeedDiff + HTeamConfFactor + 
                 LTeamConfFactor,
                       data = tourney_detailed_train,
                       type = classification, 
                       mrty = 3,
                       ntree = 400,
                       importance = TRUE,
                       localImp = TRUE)

rf_fit

plot(rf_fit, ylim = c(0, 1))

explain_forest(rf_fit, interactions = TRUE, data = tourney_detailed_train)


preds_test_DF <- data.frame(
  scores_logit = predict(rf_fit, type = "prob", newdata = tourney_detailed_test),
  tourney_detailed_test
)

View(preds_test_DF)

preds_test_DF <- preds_test_DF %>% mutate(
  class_pred05 = ifelse(scores_logit.1 > .5, "Yes", "No")
)

table(preds_test_DF$class_pred05, preds_test_DF$higher_team_won)

View(preds_test_DF)

potential_upsets <- preds_test_DF %>% filter(between(preds_test_DF$scores_logit.1, .4, .6))

View(potential_upsets)

View(teams)

```



```{r}
# summary statistics
summary(tourney_detailed_result)

# wins per team
tourney_wins_per_team <- tourney_detailed_result %>% group_by(WTeamName) %>% 
  summarize(num_wins = n()) %>%
  arrange(desc(num_wins))
head(tourney_wins_per_team)

# wins per team per season
wins_per_team_per_season <- tourney_detailed_result %>% group_by(Season) %>% 
  count(WTeamName)
head(wins_per_team_per_season)

# summary details of score by seed
seed_details <- tourney_detailed_result %>% group_by(WTeamSeed) %>%
  summarize(avg_points_per_seed = mean(WScore),
            max_points_per_seed = max(WScore),
            min_points_per_seed = min(WScore))
seed_details

# summary details of score by conference
conf_details <- tourney_detailed_result %>% group_by(WTeamConf) %>%
  summarize(avg_points_per_conf = mean(WScore),
            max_points_per_conf = max(WScore),
            min_points_per_conf = min(WScore))
conf_details

# summary details of three points by season
three_pt_details <- tourney_detailed_result %>% group_by(Season) %>%
  summarize(avg_three_pts = mean(WFGM3),
            max_three_pts = max(WFGM3),
            min_three_pts = min(WFGM3))
three_pt_details

# summay details of field goals by season
field_goals_details <- tourney_detailed_result %>% group_by(Season) %>%
  summarize(avg_field_goals = mean(WFGM),
            max_field_goals = max(WFGM),
            min_field_foals = min(WFGM))
field_goals_details


# summary details of score by winning
winner_seed_details <- tourney_detailed_result %>% group_by(Season, WTeamSeed) %>%
  summarize(avg_points_per_WTeamSeed = mean(WScore),
            max_points_per_WTeamSeed = max(WScore),
            min_points_per_WTeamSeed = min(WScore))
winner_seed_details

```


```{r}
# plots to reveal interesting patterns

library('ggthemes')

# top ten conferences frequency of wins
p4 <- ggplot(tourney_detailed_result, aes(x=WTeamConfFactor)) +
  geom_bar() +
  labs(x = "Conference",
       title = "Frequency of Wins By Conference")

p4

# field goals made vs score difference
p1 <- ggplot(
  tourney_detailed_result,
  aes(x = WFGM, y = scoreDiff)) + 
  geom_point() +
  labs(x = "Field Goals Made",
       y = "Score Difference",
       title = "Score difference and field goals made") +
  theme_economist()
p1

# density plot by conference
library(ggridges)
p2 <- ggplot(tourney_detailed_result, aes(x = scoreDiff, y = WTeamConfFactor, fill = WTeamConfFactor)) +
  geom_density_ridges() + 
  labs(x = "Score Difference",
       y = "Winning Team Conference")

p2

# scatter plot of winning scores and conferences
p3 <- ggplot(tourney_detailed_result, aes(x = WScore, y = WTeamConfFactor)) +
  geom_point() + 
  labs(x = "Winning Score",
       y = "Winning Team Conference")
  
p3

# correlation plot of a variety of game stats
library(corrplot)
cormat <- cor(tourney_detailed_result %>% select(LScore, WScore,
                                                    WFGA, LFGA,
                                                 WAst, LAst, WFTM, LFTM, 
                                                    WFGM, LFGM) %>% drop_na())
corrplot(cormat, method = "number", type="lower")

```


```{r}
# intial models we may want to fit
# we should be looking to test against the regular season data and predict into the tournament data for each year - try and get win probabilities


# making winning binomial
tourney_detailed_result <- tourney_detailed_result %>% mutate(WBinom = rep(1))
mod1 <- glm(WBinom ~ LTeamName, 
            data = tourney_detailed_result)

```