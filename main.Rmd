---
title: "Main R Markdown Document For NCAA Basketball Analysis"
author: "Ben Wasserman and Connor Kennedy"
output:
  pdf_document: default
  html_document: default
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library('tidyverse')
library('magrittr')
library('caret')
```

In this document we clean the data, join the day, add some columns, create factors, and provide some summary statistics around the data. We are  also interested in adding TV ratings and/or revenue to see how upsets and seasons affect TV ratings and revenue generated

```{r}
# get and set working directory

# remove environment variables
rm(list = ls())

# read in files
tourney_games <- read.csv("ConferenceTourneyGames.csv")
tourney_compact_results <- read.csv("NCAATourneyCompactResults.csv")
regular_season_compact_results <- read.csv("RegularSeasonCompactResults.csv")
#seasons <- read.csv("Seasons.csv")
#team_coaches <- read.csv("TeamCoaches.csv")
teams <- read.csv("Teams.csv")
team_conferences <- read.csv("TeamConferences.csv")
tourney_seeds <- read.csv("NCAATourneySeeds.csv")
tourney_seeds_round_slots <- read.csv("NCAATourneySeedRoundSlots.csv")
tourney_detailed_result <- read.csv("NCAATourneyDetailedResults.csv")
tourney_slots <- read.csv("NCAATourneySlots.csv")
regular_season_detailed_result <- read.csv("RegularSeasonDetailedResults.csv")
rankings <- read.csv("MasseyOrdinals.csv")
```

- Parse tournament data
```{r}
########### BELOW ARE A VARIETY OF DATA CLEANING AND FEATURE ENGINEERING ################
tourney_slots <- tourney_slots %>% rename(GameSlot = Slot)

rankings <- rankings %>% filter(RankingDayNum > 132)

table(rankings$SystemName)

rankings <- rankings %>% rename(DayNum = RankingDayNum)

# parse rankings
bih_rankings <- rankings %>% filter(SystemName == 'BIH')
col_rankings <- rankings %>% filter(SystemName == 'COL')
dol_rankings <- rankings %>% filter(SystemName == 'DOL')
mor_rankings <- rankings %>% filter(SystemName == 'MOR')
wlk_rankings <- rankings %>% filter(SystemName == 'WLK')
wob_rankings <- rankings %>% filter(SystemName == 'WOB')
wol_rankings <- rankings %>% filter(SystemName == 'WOL')

bih_rankings <- bih_rankings %>% rename(WTeamID = TeamID,
                                        WRankBih = OrdinalRank)

col_rankings <- col_rankings %>% rename(WTeamID = TeamID,
                                        WRankCol = OrdinalRank)

dol_rankings <- dol_rankings %>% rename(WTeamID = TeamID,
                                        WRankDol = OrdinalRank)

wlk_rankings <- wlk_rankings %>% rename(WTeamID = TeamID,
                                        WRankWlk = OrdinalRank)

wob_rankings <- wob_rankings %>% rename(WTeamID = TeamID,
                                        WRankWob = OrdinalRank)

wol_rankings <- wol_rankings %>% rename(WTeamID = TeamID,
                                        WRankWol = OrdinalRank)

mor_rankings <- mor_rankings %>% rename(WTeamID = TeamID,
                                        WRankMor = OrdinalRank)


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = bih_rankings,
                                    by = c("Season", "WTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wob_rankings,
                                    by = c("Season", "WTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wol_rankings,
                                    by = c("Season", "WTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wlk_rankings,
                                    by = c("Season", "WTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = dol_rankings,
                                    by = c("Season", "WTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = col_rankings,
                                    by = c("Season", "WTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = mor_rankings,
                                    by = c("Season", "WTeamID"))


# add losing teams rankings
bih_rankings <- bih_rankings %>% rename(LTeamID = WTeamID,
                                        LRankBih = WRankBih)

col_rankings <- col_rankings %>% rename(LTeamID = WTeamID,
                                        LRankCol = WRankCol)

dol_rankings <- dol_rankings %>% rename(LTeamID = WTeamID,
                                        LRankDol = WRankDol)

wlk_rankings <- wlk_rankings %>% rename(LTeamID = WTeamID,
                                        LRankWlk = WRankWlk)

wob_rankings <- wob_rankings %>% rename(LTeamID = WTeamID,
                                        LRankWob = WRankWob)

wol_rankings <- wol_rankings %>% rename(LTeamID = WTeamID,
                                        LRankWol = WRankWol)

mor_rankings <- mor_rankings %>% rename(LTeamID = WTeamID,
                                        LRankMor = WRankMor)


tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = bih_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wob_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wol_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = wlk_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = dol_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = col_rankings,
                                    by = c("Season", "LTeamID"))

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = mor_rankings,
                                    by = c("Season", "LTeamID"))

# remove unecessary columns
tourney_detailed_result = tourney_detailed_result[,-grep("^DayNum.",colnames(tourney_detailed_result))]
tourney_detailed_result = tourney_detailed_result[,-grep("^SystemName",colnames(tourney_detailed_result))]


# merge rounds, teams, and seeds
rounds_df <- left_join(x = tourney_slots,
                       y = tourney_seeds_round_slots,
                       by = "GameSlot")

# reorder by column name
rounds_df <- rounds_df[c("Season", "GameSlot", "WeakSeed", "GameRound")]

# get rid of duplicates
rounds_df <- rounds_df[!duplicated(rounds_df[1:4]),]

# join by slot and season
rounds_df <- left_join(rounds_df, 
                       tourney_slots, 
                       by = c("GameSlot", "Season"))

# team conferences to tourney results
team_conferences <- team_conferences %>% rename(WTeamID = TeamID)

# join with conferences
tourney_detailed_result <- left_join(x = tourney_detailed_result,
                                     y = team_conferences, 
                                     by = c("WTeamID", "Season"))

team_conferences <- team_conferences %>% rename(LTeamID = WTeamID)

tourney_detailed_result <- left_join(x = tourney_detailed_result,
                                     y = team_conferences, 
                                     by = c("LTeamID", "Season"))

tourney_detailed_result <- tourney_detailed_result %>% rename(
  WTeamConf = ConfAbbrev.x,
  LTeamConf = ConfAbbrev.y 
)

# get rid of seeds prior to 2002 for consistency
tourney_seeds <- subset(tourney_seeds, Season > 2002)
tourney_seeds <- tourney_seeds %>% rename(WTeamID = TeamID)

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = tourney_seeds,
                                    by = c("WTeamID", "Season"))

tourney_seeds <- tourney_seeds %>% rename(LTeamID = WTeamID)

tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = tourney_seeds,
                                    by = c("LTeamID", "Season"))

tourney_detailed_result <- tourney_detailed_result %>% rename(
  WTeamSeed = Seed.x,
  LTeamSeed = Seed.y
)

# make all the seeds only numeric
tourney_detailed_result$WTeamSeed <- as.integer(gsub('[a-zA-Z]', '',
                                                     tourney_detailed_result$WTeamSeed))
tourney_detailed_result$LTeamSeed <- as.integer(gsub('[a-zA-Z]', '',
                                                     tourney_detailed_result$LTeamSeed))


View(tourney_detailed_result)

# now I'm going to look to make a model for lower team wins and higher team wins
tourney_detailed_result <- tourney_detailed_result %>% mutate(
  lower_team = pmin(WTeamID, LTeamID),
  higher_team = pmax(WTeamID, LTeamID),
  higher_team_won = ifelse(higher_team == WTeamID, 1, 0),
  HTSeed = ifelse(higher_team == WTeamID, WTeamSeed, LTeamSeed),
  LTSeed = ifelse(lower_team == WTeamID, WTeamSeed, LTeamSeed),
  HTScore = ifelse(higher_team == WTeamID, WScore, LScore),
  LTScore = ifelse(lower_team == WTeamID, WScore, LScore),
  HTConf = ifelse(higher_team == WTeamID, as.character(WTeamConf), as.character(LTeamConf)),
  LTConf = ifelse(lower_team == WTeamID, as.character(WTeamConf), as.character(LTeamConf)),
  HTFGM = ifelse(higher_team == WTeamID, WFGM, LFGM),
  LTFGM = ifelse(lower_team == WTeamID, WFGM, LFGM),
  HTFGA = ifelse(higher_team == WTeamID, WFGA, LFGA),
  LTFGA = ifelse(lower_team == WTeamID, WFGA, LFGA),
  HTFGM3 = ifelse(higher_team == WTeamID, WFGM3, LFGM3),
  LTFGM3 = ifelse(lower_team == WTeamID, WFGM3, LFGM3),
  HTFGA3 = ifelse(higher_team == WTeamID, WFGA3, LFGA3),
  LTFGA3 = ifelse(lower_team == WTeamID, WFGA3, LFGA3),
  HTFTM = ifelse(higher_team == WTeamID, WFTM, LFTM),
  LTFTM = ifelse(lower_team == WTeamID, WFTM, LFTM),
  HTFTA = ifelse(higher_team == WTeamID, WFTA, LFTA),
  LTFTA = ifelse(lower_team == WTeamID, WFTA, LFTA),
  HTOR = ifelse(higher_team == WTeamID, WOR, LOR),
  LTOR = ifelse(lower_team == WTeamID, WOR, LOR),
  HTDR = ifelse(higher_team == WTeamID, WDR, LDR),
  LTDR = ifelse(lower_team == WTeamID, WDR, LDR),
  HTAst = ifelse(higher_team == WTeamID, WAst, LAst),
  LTAst = ifelse(lower_team == WTeamID, WAst, LAst),
  HTTO = ifelse(higher_team == WTeamID, WTO, LTO),
  LTTO = ifelse(lower_team == WTeamID, WTO, LTO),
  HTStl = ifelse(higher_team == WTeamID, WStl, LStl),
  LTStl = ifelse(lower_team == WTeamID, WStl, LStl),
  HTBlk = ifelse(higher_team == WTeamID, WBlk, LBlk),
  LTBlk = ifelse(lower_team == WTeamID, WBlk, LBlk),
  HTPF = ifelse(higher_team == WTeamID, WPF, LPF),
  LTPF = ifelse(lower_team == WTeamID, WPF, LPF),
  HTBih = ifelse(higher_team == WTeamID, WRankBih, LRankBih),
  LTBih = ifelse(lower_team == WTeamID, WRankBih, LRankBih),
  HTCol = ifelse(higher_team == WTeamID, WRankCol, LRankCol),
  LTCol = ifelse(lower_team == WTeamID, WRankCol, LRankCol),
  HTDol = ifelse(higher_team == WTeamID, WRankDol, LRankDol),
  LTDol = ifelse(lower_team == WTeamID, WRankDol, LRankDol),
  HTMor = ifelse(higher_team == WTeamID, WRankMor, LRankMor),
  LTMor = ifelse(lower_team == WTeamID, WRankMor, LRankMor),
  HTWlk = ifelse(higher_team == WTeamID, WRankWlk, LRankWlk),
  LTWlk = ifelse(lower_team == WTeamID, WRankWlk, LRankWlk),
  HTWob = ifelse(higher_team == WTeamID, WRankWob, LRankWob),
  LTWob = ifelse(lower_team == WTeamID, WRankWob, LRankWob),
  HTWol = ifelse(higher_team == WTeamID, WRankWol, LRankWol),
  LTWol = ifelse(lower_team == WTeamID, WRankWol, LRankWol),
  DefaultTest = ifelse(WTeamSeed > LTeamSeed, 1, 0)
)

# Create new variables that account for the randomness of seed assignment
names(tourney_detailed_result)

# need to think about correlation between all the rankings
tourney_detailed_result <- tourney_detailed_result %>% select(
  Season, DayNum, NumOT, lower_team, higher_team, higher_team_won,
  HTSeed, LTSeed, HTScore, LTScore, HTConf, LTConf, HTFGM, 
  LTFGM, HTFGA, LTFGA, HTFGM3, LTFGM3, HTFGA3, LTFGA3, HTFTM, 
  LTFTM, HTFTA, LTFTA, HTOR, LTOR, HTDR, LTDR, HTAst, LTAst, HTTO,
  LTTO, HTStl, LTStl, HTBlk, LTBlk, HTPF, LTPF, HTBih, LTBih, HTCol,
  LTCol, HTDol, LTDol, HTMor, LTMor, HTWlk, LTWlk, HTWob, LTWob, HTWol,
  LTWol, DefaultTest
)

dim(tourney_detailed_result)

# add team names
teams <- teams %>% select(TeamName, TeamID)
teams <- teams %>% rename(lower_team = TeamID)
tourney_detailed_result <-left_join(x = tourney_detailed_result,
                                    y = teams,
                                    by = "lower_team")


teams <- teams %>% rename(higher_team = lower_team)
tourney_detailed_result <- left_join(x = tourney_detailed_result,
                                     y = teams, 
                                     by = "higher_team")


# renaming
tourney_detailed_result %<>% rename(LowerTeamName = TeamName.x,
                                    HigherTeamName = TeamName.y)

# add score difference
tourney_detailed_result <- tourney_detailed_result %>% mutate(scoreDiff = HTScore - LTScore)


# add rounds to tourney_detailed_results
tourney_detailed_result <- tourney_detailed_result %>% mutate(Round = ifelse(
  DayNum %in% 134:135, 0,
  ifelse(DayNum %in% 136:137, 1,
         ifelse(DayNum %in% 138:139, 2,
                ifelse(DayNum %in% 143:144, 3,
                       ifelse(DayNum %in% 145:146, 4,
                              ifelse(DayNum == 152, 5,
                                     ifelse(DayNum == 154, 6, 7))))))
))


# factoring 
tourney_detailed_result %<>% mutate(Season = factor(Season),
                                    DayNum = factor(DayNum),
                                    HigherTeamName = factor(HigherTeamName),
                                    LowerTeamName = factor(LowerTeamName),
                                    NumOT = factor(NumOT))


# transition all wins and losses into deltas
# tourney_detailed_result <- tourney_detailed_result %>% mutate(
#  DFTM = WFTM - LFTM,
#  DStl = WStl - LStl,
#  DFGA = WFGA - LFGA,
#  DFGA3 = WFGA3 - LFGA3,
#  DFGM3 = WFGM3 - LFGM3,
#  DFTM = WFTM - LFTM,
#  DFTA = WFTA - LFTA,
#  DOR = WOR - LOR,
#  DDR = WDR - LDR,
#  DTO = WTO - LTO,
#  DAst = WAst - LAst,
#  DBlk = WBlk - LBlk,
#  DPF = WPF - LPF
# )

tourney_detailed_result <- tourney_detailed_result %>% mutate(HTeamConfFactor = fct_lump(HTConf, 10))

tourney_detailed_result <- tourney_detailed_result %>% mutate(LTeamConfFactor = 
                                                                fct_lump(LTConf, 10))

View(tourney_detailed_result)

# tourney_selected_vars <- tourney_detailed_result %>% select(
#  DFTM, DStl, DFGA, DFGA3, DFGM3, DFTA, DOR, DDR,
#  DTO, DAst, Round, WTeamConfFactor, WTeamID, LTeamID,
#  LTeamConfFactor, scoreDiff, WTeamSeed, LTeamSeed, DBlk, DPF,
#  higher_team_won, LFTM, LStl, LFGA, LFGA3, LFGM3, LFTA, LOR,
#  LDR, LTO, LAst, WFTM, WStl, WFGA, WFGA3, WFGM3, WFTA, WOR, WDR, WTO, WAst
#)

tourney_detailed_result <- tourney_detailed_result %>% mutate(
  SeedDifference = HTSeed - LTSeed
)

```

See how well the model performs only by seed
```{r}
preds_seed_df <- data.frame(
  tourney_detailed_result
)

preds_seed_df <- preds_seed_df %>% mutate(
  class_pred = ifelse(DefaultTest == 1, "Yes", "No")
)

table(preds_seed_df$class_pred, preds_seed_df$higher_team_won)

```


```{r}
tourney_detailed_result <- na.omit(tourney_detailed_result)

names(tourney_detailed_result)

glm_fit <- glm(higher_team_won ~ SeedDifference + HTBih + LTBih + HTWol + LTWol + HTWlk + LTWlk + HTWob
               + LTWob + HTCol + LTCol + HTMor + LTMor + HTDol + LTDol + LTeamConfFactor,
               data = tourney_detailed_result,
               family = binomial)

summary(glm_fit)

preds_train_DF <- data.frame(
  scores_logit = predict(glm_fit, type = "response"),
  tourney_detailed_result
)

preds_train_DF <- preds_train_DF %>% mutate(
  class_pred05 = ifelse(scores_logit > .5, "Yes", "No")
)

table(preds_train_DF$class_pred05, preds_train_DF$higher_team_won)
```

Run some basic models against the tournament data
```{r}
# split into testing and training data


# try out a logistic model
glm_fit <- glm(higher_team_won ~ SeedDifference + HTeamConfFactor + LTeamConfFactor,
               data = tourney_detailed_result,
               family = binomial)

summary(glm_fit)

preds_train_DF <- data.frame(
  scores_logit = predict(glm_fit, type = "response"),
  tourney_detailed_result
)

preds_train_DF <- preds_train_DF %>% mutate(
  class_pred05 = ifelse(scores_logit > .5, 1, 0)
)

# now I can start to do more with this and jump into more statistics
View(preds_train_DF)

# training data set
table(preds_train_DF$class_pred05, preds_train_DF$higher_team_won)

# NEXT WE SHOULD ADD ROC, LIFT CHART, and AUC

```


Random Forest Model
```{r}


```


```{r}
library(glmnet)
library(glmnetUtils)
library(coefplot)

tourney_without_conf <- tourney_detailed_result %>% select(-c(HTeamConfFactor, LTeamConfFactor, HTConf, LTConf, HigherTeamName, LowerTeamName, scoreDiff, DayNum, Season, NumOT, HTTO, LTTO, LTFGA, LTFGA3, LTFGM, LTFTM, LTFTA,
                                                              LTBlk, LTStl, LTOR, LTDR, LTAst, LTFGM3, LTPF,
                                                              LTScore, HTScore, higher_team, lower_team,
                                                              HTSeed, LTSeed,
                                                              Round))

# alpha = 0 for ridge SeedDifference + HTeamConfFactor + LTeamConfFactor
ridge_fit <- cv.glmnet(higher_team_won ~ .,
          data = tourney_without_conf,
          family = "binomial",
          alpha = 0,
          nfolds = 10)

coefpath(ridge_fit)

plot(lasso_fit)

lasso_preds <- predict(lasso_fit, newdata = tourney_detailed_result, s = lasso_fit$lambda.min)

preds_train_lasso <- data.frame(
  tourney_detailed_result,
  lasso_preds
)

preds_train_lasso <- preds_train_lasso %>% mutate(
  class_pred05 = ifelse(lasso_preds > .5, "Yes", "No")
)

table(preds_train_DF$class_pred05, preds_train_DF$higher_team_won)

```


- Parse regular season data
```{r}
################### PARSE REGULAR SEASON DATA ###########################

View(regular_season_detailed_result)
View(team_conferences)

team_conferences <- read.csv("TeamConferences.csv")

# team conferences to tourney results
team_conferences <- team_conferences %>% rename(WTeamID = TeamID)

# join with conferences
regular_detailed_result <- left_join(x = regular_season_detailed_result,
                                     y = team_conferences, 
                                     by = c("WTeamID", "Season"))

team_conferences <- team_conferences %>% rename(LTeamID = WTeamID)

regular_detailed_result <- left_join(x = regular_detailed_result,
                                     y = team_conferences, 
                                     by = c("LTeamID", "Season"))

regular_detailed_result <- regular_detailed_result %>% rename(
  WTeamConf = ConfAbbrev.x,
  LTeamConf = ConfAbbrev.y 
)


# now I'm going to look to make a model for lower team wins and higher team wins
regular_detailed_result <- regular_detailed_result %>% mutate(
  lower_team = pmin(WTeamID, LTeamID),
  higher_team = pmax(WTeamID, LTeamID),
  lower_team_won = ifelse(WTeamID == lower_team, 1, 0)
)

View(regular_detailed_result)

# add team names
teams <- teams %>% select(TeamName, TeamID)
teams <- teams %>% rename(WTeamID = TeamID)
regular_detailed_result <-left_join(x = regular_detailed_result,
                                    y = teams,
                                    by = "WTeamID")

teams <- teams %>% rename(LTeamID = WTeamID)
regular_detailed_result <- left_join(x = regular_detailed_result,
                                     y = teams, 
                                     by = "LTeamID")

# renaming
regular_detailed_result %<>% rename(WTeamName = WTeamID,
                                    LTeamName = LTeamID)

# add score difference
regular_detailed_result <- regular_detailed_result %>% mutate(scoreDiff = WScore - LScore)

# add rounds to tourney_detailed_results
# tourney_detailed_result <- tourney_detailed_result %>% mutate(Round = ifelse(
#  DayNum %in% 134:135, 0,
#  ifelse(DayNum %in% 136:137, 1,
#         ifelse(DayNum %in% 138:139, 2,
#                ifelse(DayNum %in% 143:144, 3,
#                       ifelse(DayNum %in% 145:146, 4,
#                              ifelse(DayNum == 152, 5,
#                                     ifelse(DayNum == 154, 6, 7))))))
#))

# factoring 
regular_detailed_result %<>% mutate(Season = factor(Season),
                                    DayNum = factor(DayNum),
                                    WTeamName = factor(WTeamName),
                                    LTeamName = factor(LTeamName),
                                    NumOT = factor(NumOT))


# transition all wins and losses into deltas
regular_detailed_result <- regular_detailed_result %>% mutate(
  DFTM = WFTM - LFTM,
  DStl = WStl - LStl,
  DFGA = WFGA - LFGA,
  DFGA3 = WFGA3 - LFGA3,
  DFGM3 = WFGM3 - LFGM3,
  DFTM = WFTM - LFTM,
  DFTA = WFTA - LFTA,
  DOR = WOR - LOR,
  DDR = WDR - LDR,
  DTO = WTO - LTO,
  DAst = WAst - LAst,
  DBlk = WBlk - LBlk,
  DPF = WPF - LPF
)

regular_detailed_result <- regular_detailed_result %>% select(
  DFTM, DStl, DFGA, DFGA3, DFGM3, DFTA, DOR, DDR,
  DTO, DAst, Season, WTeamName, LTeamName, WTeamConf,
  LTeamConf, scoreDiff, DBlk, DPF, lower_team,
  higher_team, lower_team_won 
)

View(regular_detailed_result)

regular_detailed_result <- regular_detailed_result %>% mutate(WTeamConfFactor = fct_lump(WTeamConf, 10))

regular_detailed_result <- regular_detailed_result %>% mutate(LTeamConfFactor = 
                                                                fct_lump(LTeamConf, 10))

```


- Do K fold cross validation by splitting into regular season and tournament data and then training and testing on each
```{r}
# season 2002 -> 2018
folds <- 2018 - 2003
curr_year <- 2003

preds_DF <- data.frame (
  folds = folds,
  preds_KFC = NA
)

# you're going to want to get this on a season by season basis
for (i in 1:folds) {
  training_df <- subset(regular_detailed_result, Season == curr_year)
  curr_year <- curr_year + 1
  mod <- glm(lower_team_won ~ WTeamConfFactor + LTeamConfFactor + DAst + 
               DDR + DOR + DTO + DFGM3 + DFTM + DStl,
               data = training_df,
               family = binomial)
  
  preds <- predict(mod, newdata = training_df, type="response")
  
  preds_DF[preds_DF$folds == i, "preds_KFC"] <- preds
}


```


```{r}
# summary statistics
summary(tourney_detailed_result)

# wins per team
tourney_wins_per_team <- tourney_detailed_result %>% group_by(WTeamName) %>% 
  summarize(num_wins = n()) %>%
  arrange(desc(num_wins))
head(tourney_wins_per_team)

# wins per team per season
wins_per_team_per_season <- tourney_detailed_result %>% group_by(Season) %>% 
  count(WTeamName)
head(wins_per_team_per_season)

# summary details of score by seed
seed_details <- tourney_detailed_result %>% group_by(WTeamSeed) %>%
  summarize(avg_points_per_seed = mean(WScore),
            max_points_per_seed = max(WScore),
            min_points_per_seed = min(WScore))
seed_details

# summary details of score by conference
conf_details <- tourney_detailed_result %>% group_by(WTeamConf) %>%
  summarize(avg_points_per_conf = mean(WScore),
            max_points_per_conf = max(WScore),
            min_points_per_conf = min(WScore))
conf_details

# summary details of three points by season
three_pt_details <- tourney_detailed_result %>% group_by(Season) %>%
  summarize(avg_three_pts = mean(WFGM3),
            max_three_pts = max(WFGM3),
            min_three_pts = min(WFGM3))
three_pt_details

# summay details of field goals by season
field_goals_details <- tourney_detailed_result %>% group_by(Season) %>%
  summarize(avg_field_goals = mean(WFGM),
            max_field_goals = max(WFGM),
            min_field_foals = min(WFGM))
field_goals_details


# summary details of score by winning
winner_seed_details <- tourney_detailed_result %>% group_by(Season, WTeamSeed) %>%
  summarize(avg_points_per_WTeamSeed = mean(WScore),
            max_points_per_WTeamSeed = max(WScore),
            min_points_per_WTeamSeed = min(WScore))
winner_seed_details


```


```{r}
# plots to reveal interesting patterns

library('ggthemes')

# top ten conferences frequency of wins
p4 <- ggplot(tourney_detailed_result, aes(x=WTeamConfFactor)) +
  geom_bar() +
  labs(x = "Conference",
       title = "Frequency of Wins By Conference")

p4

# field goals made vs score difference
p1 <- ggplot(
  tourney_detailed_result,
  aes(x = WFGM, y = scoreDiff)) + 
  geom_point() +
  labs(x = "Field Goals Made",
       y = "Score Difference",
       title = "Score difference and field goals made") +
  theme_economist()
p1

# density plot by conference
library(ggridges)
p2 <- ggplot(tourney_detailed_result, aes(x = scoreDiff, y = WTeamConfFactor, fill = WTeamConfFactor)) +
  geom_density_ridges() + 
  labs(x = "Score Difference",
       y = "Winning Team Conference")

p2

# scatter plot of winning scores and conferences
p3 <- ggplot(tourney_detailed_result, aes(x = WScore, y = WTeamConfFactor)) +
  geom_point() + 
  labs(x = "Winning Score",
       y = "Winning Team Conference")
  
p3

# correlation plot of a variety of game stats
library(corrplot)
cormat <- cor(tourney_detailed_result %>% select(LScore, WScore,
                                                    WFGA, LFGA,
                                                 WAst, LAst, WFTM, LFTM, 
                                                    WFGM, LFGM) %>% drop_na())
corrplot(cormat, method = "number", type="lower")



```


Working with TV ratings and number of viewers
```{r}
rating_round_viewers <- read.csv("rating_round_viewers.csv")
tourney_semi_views_ratings <- read.csv("semi_rating_round_viewers.csv")

View(tourney_semi_views_ratings)

# add TV ratings and viewers for championship games
rating_round_viewers %<>% rename(Round = Round)
rating_round_viewers <- rating_round_viewers %>% mutate(Season = factor(Season))

tourney_finals_views_ratings <-left_join(x = tourney_detailed_result,
                                    y = rating_round_viewers,
                                    by = c("Season", "Round"))

tourney_semi_views_ratings <- tourney_semi_views_ratings %>% rename(WTeamID = TeamID1)
tourney_semi_views_ratings <- tourney_semi_views_ratings %>% rename(LTeamID = TeamID2)

tourney_semi_views_ratings <- tourney_semi_views_ratings %>% mutate(
  Season = factor(Season)
)

# Data frame with the semi final ratings and viewers
tourney_semi_views_ratings <- left_join(x = tourney_detailed_result,
                                        y = tourney_semi_views_ratings,
                                        by= c("Season", "WTeamID", "LTeamID"))


# Data frame with the finals ratings and viewers
tourney_finals_views_ratings <- tourney_finals_views_ratings %>% filter(
  Round == 6
)

tourney_semi_views_ratings <- tourney_semi_views_ratings %>% rename(Round = Round.x)
tourney_semi_views_ratings <- tourney_semi_views_ratings %>% select(-Round.y)

tourney_semi_views_ratings <- tourney_semi_views_ratings %>% filter(
  Round == 5
)

tourney_views_ratings <- rbind(tourney_semi_views_ratings, tourney_finals_views_ratings)

tourney_views_ratings <- tourney_views_ratings %>% mutate(
  Network = factor(Network)
)

# how can I manipulate to look at upsets
View(tourney_views_ratings)
tourney_views_ratings <- tourney_views_ratings %>% mutate(
  IsUpset = ifelse(WTeamSeed < LTeamSeed, 1, 0)
)

tourney_views_ratings <- tourney_views_ratings %>% mutate(
  SeedDifference = abs(WTeamSeed - LTeamSeed)
)

tourney_views_ratings <- tourney_views_ratings %>% mutate(
  TotalThreesMade = WFGM3 + LFGM3,
  TotalFieldGoalsAttempts = WFGA + LFGA,
  TotalPointsScored = WScore + LScore
)


```


Regression for number of viewers and TV ratings
```{r}
##### Will need to do cross validation here since there isn't a ton of data ########

names(tourney_views_ratings)

lin_mod1 <- lm(Viewers ~ IsUpset + SeedDifference + Round,
               data = tourney_views_ratings)

# score difference and round are significant, ACC games are relevant
lin_mod2 <- lm(Viewers ~ scoreDiff + Round + IsUpset + 
                 relevel(WTeamConfFactor, ref="Other") + 
                 relevel(LTeamConfFactor, ref="Other"),
               data = tourney_views_ratings)

summary(lin_mod2)

preds_train_DF <- data.frame(
  preds = predict(lin_mod2),
  resids = tourney_views_ratings$Viewers - predict(lin_mod2),
  tourney_views_ratings
)

# Check for Heteroschedasticity
ggplot(preds_train_DF, aes(x = resids, y = preds)) + 
  geom_point()


# I can do an elastic net here too


# I can show a variety of graphs as well

```


```{r}
# intial models we may want to fit
# we should be looking to test against the regular season data and predict into the tournament data for each year - try and get win probabilities


# making winning binomial
tourney_detailed_result <- tourney_detailed_result %>% mutate(WBinom = rep(1))
mod1 <- glm(WBinom ~ LTeamName, 
            data = tourney_detailed_result)

```